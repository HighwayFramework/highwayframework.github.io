
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Repository - The fastest and smoothest way to good architecture</title>
  <meta name="author" content="Tim Rayburn & Devlin Liles">

   
  <meta name="description" content="">
  
  <meta name="keywords" content="">

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://hwyfwk.com/blog/2013/10/19/repository/">
  <link href="//favicon.png" rel="icon">
  <link href='http://fonts.googleapis.com/css?family=Quicksand:300,400' rel='stylesheet' type='text/css'>
  <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,300' rel='stylesheet' type='text/css'>
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="The fastest and smoothest way to good architecture" type="application/atom+xml">
  <script src="/js/jquery.js"></script>
  <script src="/js/bootstrap-collapse.js"></script>
  <script src="/js/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/js/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <div class="navbar navbar-inverse navbar-static-top">
  	<div class="navbar-inner">
  	  <div class="container">
        <a class="btn btn-navbar" data-toggle="collapse" data-target=".navbar-responsive-collapse">
          <span class="fui-menu-24"></span>
        </a>
  	  	<div class="nav-collapse collapse navbar-responsive-collapse" style="height:0;">
  	      <ul class="nav">
    
        <li ><a href="/index.html">Home</a></li>
    
        <li ><a href="/team/index.html">Team</a></li>
    
        <li ><a href="/projects/index.html">Projects</a></li>
    
        <li ><a href="/license.html">License</a></li>
    
        <li ><a href="/releases.html">Releases</a></li>
    
        <li ><a href="/contribute.html">Contribute</a></li>
    
        <li ><a href="/support.html">Support</a></li>
    
        <li ><a href="/faq.html">FAQs</a></li>
    
</ul>

<ul class="nav pull-right">
    
    <li><a href="http://github.com/HighwayFramework" title="Github Profile"><i class="icon-github-sign social-navbar"></i></a></li>
    
    
    
    <li><a href="http://twitter.com/HwyFwk" title="Twitter Profile"><i class="icon-twitter-sign social-navbar"></i></a></li>
    
    
    
    
    <li><a href="mailto:Team@HwyFwk.com" title="Email"><i class="icon-envelope-alt social-navbar"></i></a></li>
    
</ul>

  	    </div>
  	  </div>
  	</div>
  </div>
  <div class="container" id="main">
    <div class="span12">
      <div class="row-fluid">
        <div id="content">
          <div>
<article class="hentry" role="article">
  

  <header>
  <div class="jumbotron">
    Repository
	<h5>









<i class="icon-calendar-empty"></i> <time datetime="2013-10-19T08:17:00-05:00" pubdate data-updated="true"></time></h5>
  </div>
</header>
  <div class="row-fluid">
    <div class="span12">
      <p><span class="pullquote-right" data-pullquote="IRepository is the singular interface which your business code should be aware of from Highway.Data.">
The <a href="/blog/2013/10/19/understanding-the-patterns/">Repository Pattern</a> describes an intermediary between code which uses data, and the particulars of how that data is retrieved.  In Highway.Data, we have a <code class="highlighter-rouge">Repository</code> class which is meant for this exact purpose, and it implements an <code class="highlighter-rouge">IRepository</code> interface which your code should take as a dependency.  IRepository is the singular interface which your business code should be aware of from Highway.Data.  Through it we can accomplish any database operation that is needed.
</span></p>

<p>In Highway.Data, we define our <code class="highlighter-rouge">IRepository</code> interface as follows:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">public</span> <span class="k">interface</span> <span class="nc">IRepository</span>
    <span class="p">{</span>
        <span class="n">IDataContext</span> <span class="n">Context</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
        <span class="n">IEventManager</span> <span class="n">EventManager</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>

        <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">Find</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">IQuery</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">query</span><span class="p">);</span>
        <span class="n">T</span> <span class="n">Find</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">IScalar</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">query</span><span class="p">);</span>
        <span class="k">void</span> <span class="nf">Execute</span><span class="p">(</span><span class="n">ICommand</span> <span class="n">command</span><span class="p">);</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>The interface first has two properties, those being <code class="highlighter-rouge">Context</code> and <code class="highlighter-rouge">EventManager</code>.  The details of those are covered elsewhere, though we will touch lightly on <code class="highlighter-rouge">Context</code> in this article.  The other three methods are very interesting, and each deserve a section of their own.</p>

<h1 id="example-domain">Example Domain</h1>

<p>In all of the examples below, we’ll be working with the following business domain, from our Driver’s Education company:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public class Instructor
{
    public int Id { get; set; }
    public ICollection&lt;Driver&gt; Drivers { get; set; }
}

public class Driver
{
    public int Id { get; set; }
    public string FirstName { get; set; }
    public string LastName { get; set; }
    public Car Car { get; set; }
}

public class Car
{
    public int Id { get; set; }
    public string Make { get; set; }
    public string Model { get; set; }
    public string Year { get; set; }
}
</code></pre></div></div>

<h1 id="find-multiple-things---ienumerablet-findtiqueryt-query">Find Multiple Things - IEnumerable&lt;T&gt; Find&lt;T&gt;(IQuery&lt;T&gt; query)</h1>

<p>This method is used when you want to retrieve multiple things from the database.  Let’s assume we had a MVC controller which wanted to query for all drivers who had taken a class from Instructor #5.  First thing we’ll need is a controller which has a dependency of our <code class="highlighter-rouge">IRepository</code> interface.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public class DriversController : Controller
{
    private IRepository repo;

    public DriversController(IRepository repo)
    {
        this.repo = repo;
    }
}
</code></pre></div></div>

<p>Now then, we’ll add an action method to this controller, which is called <code class="highlighter-rouge">ByInstructor</code> which takes an <code class="highlighter-rouge">int</code> of the Instructor’s <code class="highlighter-rouge">Id</code>.  Then we call to the repository, passing in an instance of our Query object called <code class="highlighter-rouge">FindDriversByInstructorId</code>.  Like so:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public class DriversController : Controller
{
    private IRepository repo;

    public DriversController(IRepository repo)
    {
        this.repo = repo;
    }

    public ActionResult ByInstructor(int instructorId)
    {
        IEnumerable&lt;Driver&gt; drivers = repo.Find(new FindDriversByInstructorId(instructorId));
        return View(drivers);
    }
}
</code></pre></div></div>

<p>Note how our <code class="highlighter-rouge">DriversController</code> is not aware of anything database specific, like connection strings, or even which Object Relational Mapper (ORM) is servicing the request.  All it knows is that it is asking for multiple drivers, and receiving them.  Now, you might be curious what’s going on inside of <code class="highlighter-rouge">FindDriversByInstructorId</code>, and while we’re not discussing queries here, I want to show you the code so you don’t think there is magic going on:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public class FindDriversByInstructorId : Query&lt;Driver&gt;
{
    public FindDriversByInstructorId(int instructorId)
    {
        ContextQuery = c =&gt; c.AsQueryable&lt;Instructor&gt;().SelectMany(e =&gt; e.Drivers);
    }
}
</code></pre></div></div>

<h1 id="find-one-thing---t-findtiscalart-query">Find One Thing - T Find&lt;T&gt;(IScalar&lt;T&gt; query)</h1>

<p>Our next method is used when we want to retrieve a singular thing from the database.  That one thing might be an <code class="highlighter-rouge">int</code>, for instance a count of rows, or it might be an entity like <code class="highlighter-rouge">Car</code>, for instance getting the car for a particular driver.  This time we’ll be working with the <code class="highlighter-rouge">CarController</code>, and we’re going to retrieve a <code class="highlighter-rouge">Car</code> by it’s <code class="highlighter-rouge">Driver</code>’s <code class="highlighter-rouge">Id</code>.  Our controller would use <code class="highlighter-rouge">IRepository</code> like so:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public class CarController : Controller
{
    private IRepository repo;

    public CarController(IRepository repo)
    {
        this.repo = repo;
    }

    public ActionResult ByDriver(int driverId)
    {
        Car car = repo.Find(new FindCarByDriverId(driverId));
        return View(car);
    }
}
</code></pre></div></div>

<p>As you can see, we return a singular object, once again completely unaware of which ORM is doing the work, or anything related to the database.  Like before, while we’re not discussing Scalars here, this is the query being used :</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public class FindCarByDriverId : Scalar&lt;Car&gt;
{
    public FindCarByDriverId(int driverId)
    {
        ContextQuery = c =&gt; c.AsQueryable&lt;Driver&gt;()
            .Where(e =&gt; e.Id == driverId)
            .Select(e =&gt; e.Car)
            .FirstOrDefault();
    }
}
</code></pre></div></div>

<h1 id="do-something---void-executeicommand-command">Do Something - void Execute(ICommand command)</h1>

<p>Our final method is used to perform a command that has no return value.  There are often times when you want the database to do some work, but you don’t need it to return anything as a result of that work, this is what <code class="highlighter-rouge">Execute</code> is for.  In our example, we’re going to add another method to our <code class="highlighter-rouge">CarController</code> class from the previous example, which will remove all Chevy vehicles from our database.  Our <code class="highlighter-rouge">CarController</code> will now look like this:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public class CarController : Controller
{
    private IRepository repo;

    public CarController(IRepository repo)
    {
        this.repo = repo;
    }

    public ActionResult ByDriver(int driverId)
    {
        Car car = repo.Find(new FindCarByDriverId(driverId));
        return View(car);
    }

    public ActionResult RemoveChevy()
    {
        repo.Execute(new DropMake("Chevy"));
        return RedirectToAction("Index", "Home");
    }
}
</code></pre></div></div>

<p>Note how <code class="highlighter-rouge">Execute</code> returns no value.  Our <code class="highlighter-rouge">DropMake</code> command looks like this :</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public class DropMake : Command
{
    public DropMake(string make)
    {
        // THIS IS A REALLY BAD WAY TO REMOVE MULTIPLE ROWS
        // IT WOULD NORMALLY BE MUCH BETTER TO USE AN
        // AdvancedCommand TO PERFORM THIS TYPE OF OPERATION
        ContextQuery = c =&gt;
        {
            var cars = c.AsQueryable&lt;Car&gt;().Where(car =&gt; car.Make == make);
            foreach (var car in cars)
            {
                c.Remove(car);
            }
        };
    }
}
</code></pre></div></div>

<p>As the comment says, this is an inefficient way to remove multiple rows, please review the documentation on <code class="highlighter-rouge">AdvancedCommand</code> if you really need to perform a delete like this.</p>

    </div>
  </div>



  <footer>
    <hr>
    
    <div class="row-fluid">
      
      <div class="span6">
        <p class="meta">
        
        



  <a href="/blog/categories/data/"><span class="badge">data</span></a>

  <a href="/blog/categories/feature/"><span class="badge">feature</span></a>




        </p>
      </div>
      
      <div class="span6 social-sharing">
        <div class="sharing">
  <div class="addthis_toolbox addthis_default_style ">
  
  <a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
  
  
  <a class="addthis_button_tweet"></a>
  
  
  <a class="addthis_counter addthis_pill_style"></a>
  </div>
  <script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid="></script>
</div>

      </div>
      
      
    </div>
    
    
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>



        </div>
      </div>
      <div class="row-fluid">
        <footer class="footer-page" role="contentinfo">
          <p>
  Copyright &copy; 2019 - Tim Rayburn & Devlin Liles -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span> - Theme by <a href="http://alexgaribay.com">Alex Garibay</a>
</p>


        </footer>
      </div>
    </div>
  </div>
  

<script type="text/javascript">
      var disqus_shortname = 'highwayframework';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://hwyfwk.com/blog/2013/10/19/repository/';
        var disqus_url = 'http://hwyfwk.com/blog/2013/10/19/repository/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>





  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
