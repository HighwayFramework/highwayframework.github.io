
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Testable Data Access At Every Layer - The fastest and smoothest way to good architecture</title>
  <meta name="author" content="Tim Rayburn & Devlin Liles">

   
  <meta name="description" content="">
  
  <meta name="keywords" content="">

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://hwyfwk.com/blog/2013/10/15/testable-data-access-at-every-level">
  <link href="/favicon.png" rel="icon">
  <link href='http://fonts.googleapis.com/css?family=Quicksand:300,400' rel='stylesheet' type='text/css'>
  <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,300' rel='stylesheet' type='text/css'>
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="The fastest and smoothest way to good architecture" type="application/atom+xml">
  <script src="/js/jquery.js"></script>
  <script src="/js/bootstrap-collapse.js"></script>
  <script src="/js/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/js/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <div class="navbar navbar-inverse navbar-static-top">
  	<div class="navbar-inner">
  	  <div class="container">
        <a class="btn btn-navbar" data-toggle="collapse" data-target=".navbar-responsive-collapse">
          <span class="fui-menu-24"></span>
        </a>
  	  	<div class="nav-collapse collapse navbar-responsive-collapse" style="height:0;">
  	      <ul class="nav">
    
        <li ><a href="/index.html">Home</a></li>
    
        <li ><a href="/team/index.html">Team</a></li>
    
        <li ><a href="/projects/index.html">Projects</a></li>
    
        <li ><a href="/license.html">License</a></li>
    
        <li ><a href="/releases.html">Releases</a></li>
    
        <li ><a href="/contribute.html">Contribute</a></li>
    
        <li ><a href="/support.html">Support</a></li>
    
        <li ><a href="/faq.html">FAQs</a></li>
    
</ul>

<ul class="nav pull-right">
    
    <li><a href="http://github.com/HighwayFramework" title="Github Profile"><i class="icon-github-sign social-navbar"></i></a></li>
    
    
    
    <li><a href="http://twitter.com/HwyFwk" title="Twitter Profile"><i class="icon-twitter-sign social-navbar"></i></a></li>
    
    
    
    
    <li><a href="mailto:Team@HwyFwk.com" title="Email"><i class="icon-envelope-alt social-navbar"></i></a></li>
    
</ul>

  	    </div>
  	  </div>
  	</div>
  </div>
  <div class="container" id="main">
    <div class="span12">
      <div class="row-fluid">
        <div id="content">
          <div>
<article class="hentry" role="article">
  

  <header>
  <div class="jumbotron">
    Testable Data Access at Every Layer
	<h5>








  


<i class="icon-calendar-empty"></i> <time datetime="2013-10-15T12:58:00-07:00" pubdate data-updated="true">Oct 15<span>th</span>, 2013</time></h5>
  </div>
</header>
  <div class="row-fluid">
    <div class="span12">
      <h1>Installing Highway.Data</h1>

<p>Our first and most important feature of Highway.Data is wrapping the Highway.Data <code>IDataContext</code> interface around the specific ( normally leaky ) implementation of the persistence technology.  You get started with Highway.Data by simply opening the Package Manager Console and typeing which ever of our adapters you decide to use:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='powershell'><span class='line'><span class="n">Install-Package</span> <span class="n">Highway</span><span class="p">.</span><span class="n">Data</span><span class="p">.</span><span class="n">EntityFramework</span>
</span><span class='line'><span class="n">Install-Package</span> <span class="n">Highway</span><span class="p">.</span><span class="n">Data</span><span class="p">.</span><span class="n">NHibernate</span>
</span><span class='line'><span class="n">Install-Package</span> <span class="n">Highway</span><span class="p">.</span><span class="n">Data</span><span class="p">.</span><span class="n">RavenDb</span>
</span></code></pre></td></tr></table></div></figure>


<p>This will bring in your chosen persistence framework, Highway.Data, Highway.Pavement, and some common wrappers around Logging and Service location.</p>

<h1>Mocking Framework</h1>

<p>Chose any one you like.</p>

<ol>
<li><a href="http://hibernatingrhinos.com/oss/rhino-mocks">Rhino Mocks</a> We use this in developing the Highway Framework, so this will be what we use in examples.</li>
<li><a href="http://www.moqthis.com/">Moq</a></li>
<li><a href="http://msdn.microsoft.com/en-us/library/hh549175%28v=vs.120%29.aspx">Microsoft Fakes</a></li>
<li><a href="http://www.telerik.com/products/mocking.aspx">JustMock</a></li>
<li><a href="http://sourceforge.net/projects/easymocknet/">EasyMock.NET</a></li>
<li><a href="http://www.typemock.com/">TypeMock</a></li>
<li><a href="http://nsubstitute.github.io/">NSubstitute</a></li>
<li><a href="http://nmock3.codeplex.com/">NMock</a></li>
<li><a href="https://github.com/fakeiteasy">FakeItEasy</a></li>
<li>the other dozens we didn&rsquo;t enumerate</li>
</ol>


<h1>Introducing the IRepository</h1>

<p>Let&rsquo;s create a variable of type <code>IRepository</code> and provide it a mock, like so:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">IRepository</span> <span class="n">repository</span> <span class="p">=</span> <span class="n">MockRepository</span><span class="p">.</span><span class="n">GenerateMock</span><span class="p">&lt;</span><span class="n">IRepository</span><span class="p">&gt;();</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now, Let&rsquo;s look at the definition of <code>IRepository</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">interface</span> <span class="n">IRepository</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">IDataContext</span> <span class="n">Context</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>    <span class="n">IEventManager</span> <span class="n">EventManager</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>    <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">Find</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">IQuery</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">query</span><span class="p">);</span>
</span><span class='line'>    <span class="n">T</span> <span class="n">Find</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">IScalar</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">query</span><span class="p">);</span>
</span><span class='line'>    <span class="k">void</span> <span class="nf">Execute</span><span class="p">(</span><span class="n">ICommand</span> <span class="n">command</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The interface provides a way to do Query Object based execution for Queries / Commands / Scalars.If you would like to know more about how these are wired together at a fundemental level, check out our <a href="/blog/2013/10/19/understanding-the-patterns/">Patterns Post</a>.</p>

<ul>
<li>Unit of Work &ndash; <code>Context</code></li>
<li>Event/Interceptor Management &ndash; <code>EventManager</code></li>
<li>Data Access &ndash; <code>Find&lt;T&gt;(IQuery&lt;T&gt; query) &amp;&amp; Find&lt;T&gt;(IScalar&lt;T&gt; query)</code></li>
<li>Data Execution &ndash; <code>Execute(ICommand command)</code></li>
</ul>


<p>From a testing perspective this provides great abstractions. We can test our business logic without having to worry about even the structure of our queries.  Consider the following classes and test:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">Driver</span> <span class="p">{</span> <span class="k">public</span> <span class="kt">string</span> <span class="n">Name</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">DriverEducationService</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="n">IRepository</span> <span class="n">repository</span><span class="p">;</span>
</span><span class='line'>    <span class="k">public</span> <span class="nf">DriverEducationService</span><span class="p">(</span><span class="n">IRepository</span> <span class="n">repository</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="n">repository</span> <span class="p">=</span> <span class="n">repository</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="n">Driver</span> <span class="nf">GetDriver</span><span class="p">(</span><span class="kt">string</span> <span class="n">name</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">repository</span><span class="p">.</span><span class="n">Find</span><span class="p">(</span><span class="k">new</span> <span class="n">DriverByName</span><span class="p">(</span><span class="n">name</span><span class="p">));</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>A simple class that retrieves driver by name. This query is just the way we have codified that query into something that would make sense for logic to know. My logic should know it needs to find a driver by name, but shouldn&rsquo;t know how to do that. This gives us that testable abstraction.</p>

<p>Now let&rsquo;s write a test that ensures that works, without having to touch a database:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="na">[TestClass]</span>
</span><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">DriverEducationServiceTests</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="na">    [TestMethod]</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">void</span> <span class="nf">GetDriver_ShouldRetrieveADriverByName</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="c1">// Arrange</span>
</span><span class='line'>        <span class="n">IRepository</span> <span class="n">repository</span> <span class="p">=</span> <span class="n">MockRepository</span><span class="p">.</span><span class="n">GenerateMock</span><span class="p">&lt;</span><span class="n">IRepository</span><span class="p">&gt;();</span>
</span><span class='line'>        <span class="n">repository</span><span class="p">.</span><span class="n">Expect</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Find</span><span class="p">(</span><span class="n">Arg</span><span class="p">&lt;</span><span class="n">DriverByName</span><span class="p">&gt;.</span><span class="n">Is</span><span class="p">.</span><span class="n">NotNull</span><span class="p">)).</span><span class="n">Return</span><span class="p">(</span><span class="k">new</span> <span class="n">Driver</span><span class="p">(</span><span class="s">&quot;Devlin Liles&quot;</span><span class="p">));</span>
</span><span class='line'>        <span class="kt">var</span> <span class="n">target</span> <span class="p">=</span> <span class="k">new</span> <span class="n">DriverEducationService</span><span class="p">(</span><span class="n">repository</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Act</span>
</span><span class='line'>        <span class="kt">var</span> <span class="n">driver</span> <span class="p">=</span> <span class="n">target</span><span class="p">.</span><span class="n">GetDriver</span><span class="p">(</span><span class="s">&quot;Devlin Liles&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Assert</span>
</span><span class='line'>        <span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="s">&quot;Devlin Liles&quot;</span><span class="p">,</span> <span class="n">driver</span><span class="p">.</span><span class="n">Name</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now this lets us test up, but we still need to test our selection criteria in the query. Aka, test down. I would like to do this without a database. Let&rsquo;s give it a shot.</p>

<h1>Introducing the IDataContext</h1>

<p>Now, let&rsquo;s create a variable of type <code>IDataContext</code> and provide it an instance of the class <code>DataContext</code>, like so:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">IDataContext</span> <span class="n">context</span> <span class="p">=</span> <span class="n">MockRepository</span><span class="p">.</span><span class="n">GenerateMock</span><span class="p">&lt;</span><span class="n">IDataContext</span><span class="p">&gt;();</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now, Let&rsquo;s look at the definition of <code>IDataContext</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">interface</span> <span class="n">IDataContext</span> <span class="p">:</span> <span class="n">IDisposable</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">IEventManager</span> <span class="n">EventManager</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">T</span> <span class="n">Add</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">T</span> <span class="n">item</span><span class="p">)</span> <span class="k">where</span> <span class="n">T</span> <span class="p">:</span> <span class="n">class</span><span class="p">;</span>
</span><span class='line'>    <span class="n">IQueryable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">AsQueryable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;()</span> <span class="k">where</span> <span class="n">T</span> <span class="p">:</span> <span class="n">class</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">int</span> <span class="nf">Commit</span><span class="p">();</span>
</span><span class='line'>    <span class="n">T</span> <span class="n">Reload</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">T</span> <span class="n">item</span><span class="p">)</span> <span class="k">where</span> <span class="n">T</span> <span class="p">:</span> <span class="n">class</span><span class="p">;</span>
</span><span class='line'>    <span class="n">T</span> <span class="n">Remove</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">T</span> <span class="n">item</span><span class="p">)</span> <span class="k">where</span> <span class="n">T</span> <span class="p">:</span> <span class="n">class</span><span class="p">;</span>
</span><span class='line'>    <span class="n">T</span> <span class="n">Update</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">T</span> <span class="n">item</span><span class="p">)</span> <span class="k">where</span> <span class="n">T</span> <span class="p">:</span> <span class="n">class</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The interface provides a way to do all of the CRUD operations:</p>

<ul>
<li><strong>C</strong>reate &ndash; <code>Add&lt;T&gt;(T item)</code></li>
<li><strong>R</strong>ead &ndash; <code>AsQueryable&lt;T&gt;()</code></li>
<li><strong>U</strong>pdate &ndash; <code>Update&lt;T&gt;(T item)</code></li>
<li><strong>D</strong>elete &ndash; <code>Remove&lt;T&gt;(T item)</code></li>
</ul>


<p>In addition we&rsquo;ve provided a way to do two other important things:</p>

<ul>
<li>Refresh an object from the Database via <code>Reload&lt;T&gt;(T item)</code></li>
<li>Commit all work as a single transaction via <code>Commit()</code></li>
</ul>


<h2>Framework Specifics</h2>

<h3>Entity Framework &ndash; DbContext</h3>

<p>Inside the Highway.Data.EntityFramework version of <code>DataContext</code>, it is worth of note that our <code>DataContext</code> class <strong>is</strong> an instance of <code>DbContext</code>.  Our declaration looks like so:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">DataContext</span> <span class="p">:</span> <span class="n">DbContext</span><span class="p">,</span> <span class="n">IEntityDataContext</span><span class="p">,</span> <span class="n">IObservableDataContext</span><span class="p">,</span> <span class="n">IDataContext</span><span class="p">,</span> <span class="n">IDisposable</span>
</span></code></pre></td></tr></table></div></figure>


<p>Anytime you have existing code which requires a DbContext, you can instead provide an instance of the DataContext class.</p>

<h3>NHibernate &ndash; ISession</h3>

<p>Inside the Highway.Data.NHibernate version of <code>DataContext</code>, it is worth of note that our <code>DataContext</code> class <strong>is</strong> an implementor of <code>ISession</code>.  Our declaration looks like so:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">DataContext</span> <span class="p">:</span> <span class="n">ISession</span><span class="p">,</span> <span class="n">IObservableDataContext</span><span class="p">,</span> <span class="n">IDisposable</span>
</span></code></pre></td></tr></table></div></figure>


<p>Anytime you have existing code which requires a <code>ISession</code>, you can instead provide an instance of the DataContext class.</p>

<h3>RavenDb &ndash; IDocumentSession</h3>

<p>Inside the Highway.Data.RavenDb version of <code>DataContext</code>, it is worth of note that our <code>DataContext</code> class <strong>is</strong> an implementor of <code>IDocumentSession</code>.  Our declaration looks like so:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">DataContext</span> <span class="p">:</span> <span class="n">IDocumentSession</span><span class="p">,</span> <span class="n">IObservableDataContext</span><span class="p">,</span> <span class="n">IDisposable</span>
</span></code></pre></td></tr></table></div></figure>


<p>Anytime you have existing code which requires a <code>IDocumentSession</code>, you can instead provide an instance of the DataContext class.</p>

<h1>Testing with DataContext</h1>

<p>From a testing perspective this provides great abstractions.  Consider the following classes and test:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">Driver</span> <span class="p">{</span> <span class="k">public</span> <span class="kt">string</span> <span class="n">Name</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">DriverByName</span> <span class="p">:</span> <span class="n">Scalar</span><span class="p">&lt;</span><span class="n">Driver</span><span class="p">&gt;</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">public</span> <span class="nf">DriverByName</span><span class="p">(</span><span class="kt">string</span> <span class="n">name</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="n">ContextQuery</span> <span class="p">=</span> <span class="n">context</span> <span class="p">=&gt;</span> <span class="n">context</span><span class="p">.</span><span class="n">AsQueryable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;().</span><span class="n">SingleOrDefault</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Name</span> <span class="p">==</span> <span class="n">name</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>A simple class that retrieves driver by name.</p>

<p>Now let&rsquo;s write a test that ensures that works, without having to touch a database:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="na">[TestClass]</span>
</span><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">DriverEducationServiceTests</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="na">    [TestMethod]</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">void</span> <span class="nf">GetDriver_ShouldRetrieveADriverByName</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="c1">// Arrange</span>
</span><span class='line'>        <span class="kt">var</span> <span class="n">context</span> <span class="p">=</span> <span class="k">new</span> <span class="n">InMemoryDataContext</span><span class="p">();</span>
</span><span class='line'>      <span class="n">context</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="k">new</span> <span class="n">Driver</span> <span class="p">{</span> <span class="n">Name</span> <span class="p">=</span> <span class="s">&quot;Devlin Liles&quot;</span> <span class="p">});</span>
</span><span class='line'>      <span class="n">context</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="k">new</span> <span class="n">Driver</span> <span class="p">{</span> <span class="n">Name</span> <span class="p">=</span> <span class="s">&quot;Tim Rayburn&quot;</span> <span class="p">});</span>
</span><span class='line'>        <span class="kt">var</span> <span class="n">target</span> <span class="p">=</span> <span class="k">new</span> <span class="n">DriverEducationService</span><span class="p">(</span><span class="n">context</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Act</span>
</span><span class='line'>        <span class="kt">var</span> <span class="n">driver</span> <span class="p">=</span> <span class="n">target</span><span class="p">.</span><span class="n">GetDriver</span><span class="p">(</span><span class="s">&quot;Devlin Liles&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Assert</span>
</span><span class='line'>        <span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="s">&quot;Devlin Liles&quot;</span><span class="p">,</span> <span class="n">driver</span><span class="p">.</span><span class="n">Name</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now, this test doesn&rsquo;t use mocking because we provide an <code>InMemoryDataContext</code> with Highway.Data which removes the need for it in most cases.  But when it doesn&rsquo;t remove that need, we can also re-write the same test using a mocking framework like Rhino.Mocks very simply:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="na">[TestClass]</span>
</span><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">DriverEducationServiceTests</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="na">    [TestMethod]</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">void</span> <span class="nf">GetDriver_ShouldRetrieveADriverByName</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="c1">// Arrange</span>
</span><span class='line'>        <span class="kt">var</span> <span class="n">context</span> <span class="p">=</span> <span class="n">MockRepository</span><span class="p">.</span><span class="n">GenerateMock</span><span class="p">&lt;</span><span class="n">IDataContext</span><span class="p">&gt;();</span>
</span><span class='line'>      <span class="n">context</span><span class="p">.</span><span class="n">Expect</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">AsQueryable</span><span class="p">&lt;</span><span class="n">Driver</span><span class="p">&gt;())</span>
</span><span class='line'>          <span class="p">.</span><span class="n">Return</span><span class="p">(</span><span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Driver</span><span class="p">&gt;()</span>
</span><span class='line'>              <span class="p">{</span>
</span><span class='line'>                  <span class="k">new</span> <span class="n">Driver</span> <span class="p">{</span> <span class="n">Name</span> <span class="p">=</span> <span class="s">&quot;Devlin Liles&quot;</span> <span class="p">},</span>
</span><span class='line'>                  <span class="k">new</span> <span class="n">Driver</span> <span class="p">{</span> <span class="n">Name</span> <span class="p">=</span> <span class="s">&quot;Tim Rayburn&quot;</span> <span class="p">}</span>
</span><span class='line'>              <span class="p">}.</span><span class="n">AsQueryable</span><span class="p">());</span>
</span><span class='line'>
</span><span class='line'>        <span class="kt">var</span> <span class="n">target</span> <span class="p">=</span> <span class="k">new</span> <span class="n">DriverEducationService</span><span class="p">(</span><span class="n">context</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Act</span>
</span><span class='line'>        <span class="kt">var</span> <span class="n">driver</span> <span class="p">=</span> <span class="n">target</span><span class="p">.</span><span class="n">GetDriver</span><span class="p">(</span><span class="s">&quot;Devlin Liles&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Assert</span>
</span><span class='line'>        <span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="s">&quot;Devlin Liles&quot;</span><span class="p">,</span> <span class="n">driver</span><span class="p">.</span><span class="n">Name</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This test uses the mock of IDataContext to provide a way for testing filter and query logic without having a database handy. It uses a great LINQ method <code>AsQueryable()</code> to help with the return. It is a bit heavier for normal queries.</p>

<p><strong>When you are testing code that add/commits you can use a mixture of Mock levels, or the <code>InMemoryDataContext</code></strong></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="kt">var</span> <span class="n">context</span> <span class="p">=</span> <span class="n">MockRepository</span><span class="p">.</span><span class="n">GenerateMock</span><span class="p">&lt;</span><span class="n">IDataContext</span><span class="p">&gt;();</span>
</span><span class='line'><span class="kt">var</span> <span class="n">repository</span> <span class="p">=</span> <span class="n">MockRepository</span><span class="p">.</span><span class="n">GenerateMock</span><span class="p">&lt;</span><span class="n">IRepository</span><span class="p">&gt;();</span>
</span><span class='line'><span class="n">repository</span><span class="p">.</span><span class="n">Expect</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Context</span><span class="p">).</span><span class="n">Return</span><span class="p">(</span><span class="n">context</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>or</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="kt">var</span> <span class="n">repository</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Repository</span><span class="p">(</span><span class="k">new</span> <span class="n">InMemoryDataContext</span><span class="p">());</span>
</span></code></pre></td></tr></table></div></figure>


<h1>InMemoryDataContext</h1>

<p>Just a few points to keep in mind with <code>InMemoryDataContext</code>.</p>

<ol>
<li>It does not now, nor will it ever support AdvancedQuery, AdvancedCommand, or AdvancedScalar.</li>
<li>It modifies objects by ref in real time, so Commit will only rescan the graph for added or removed objects. <strong>This means changing a primitive property will change it even if you don&rsquo;t call commit</strong></li>
</ol>


    </div>
  </div>



  <footer>
    <hr>
    
    <div class="row-fluid">
      
      <div class="span6">
        <p class="meta">
        
        



  <a href="/blog/categories/data/"><span class="badge">data</span></a>

  <a href="/blog/categories/feature/"><span class="badge">feature</span></a>




        </p>
      </div>
      
      <div class="span6 social-sharing">
        <div class="sharing">
  <div class="addthis_toolbox addthis_default_style ">
  
  <a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
  
  
  <a class="addthis_button_tweet"></a>
  
  
  <a class="addthis_counter addthis_pill_style"></a>
  </div>
  <script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid="></script>
</div>

      </div>
      
      
    </div>
    
    
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>



        </div>
      </div>
      <div class="row-fluid">
        <footer class="footer-page" role="contentinfo">
          <p>
  Copyright &copy; 2015 - Tim Rayburn & Devlin Liles -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span> - Theme by <a href="http://alexgaribay.com">Alex Garibay</a>
</p>


        </footer>
      </div>
    </div>
  </div>
  

<script type="text/javascript">
      var disqus_shortname = 'highwayframework';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://hwyfwk.com/blog/2013/10/15/testable-data-access-at-every-level/';
        var disqus_url = 'http://hwyfwk.com/blog/2013/10/15/testable-data-access-at-every-level/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>





  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
